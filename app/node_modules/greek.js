
// Polytonic Greek diacritics
var diacritics = [
    "\u0300", // COMBINING GRAVE ACCENT
    "\u0301", // COMBINING ACUTE ACCENT
    "\u0304", // COMBINING MACRON
    "\u0306", // COMBINING BREVE
    "\u0308", // COMBINING DIAERESIS
    "\u0313", // COMBINING COMMA ABOVE
    "\u0314", // COMBINING REVERSED COMMA ABOVE
    "\u0342", // COMBINING GREEK PERISPOMENI
    "\u0345"  // COMBINING GREEK YPOGEGRAMMENI
].join("");

// Diacritics non-combining equivalents
var diacriticsNC = {
    "\u0300": "\u0060", // Grave Accent
    "\u0301": "\u00B4", // Acute Accent

    "\u0304": "\u2013", // Metrical Macron
    "\u0306": "\u23D1", // Metrical Breve

    "\u0308": "\u00A8", // Diaresis

    "\u0313": "\u02BC", // Modifier Letter Apostrophe
    "\u0314": "\u02BD", // Modifier Letter Reversed Comma
    "\u0342": "\u1FC0", // Greek Perispomeni
    "\u0345": "\u1FBE"  // Greek Prosgegrammeni
};

// Greek composites
var decomp = {
    "\u0385":"\u00A8\u0301",                 // GREEK DIALYTIKA TONOS
    "\u0386":"\u0391\u0301",                 // GREEK CAPITAL LETTER ALPHA WITH TONOS
    "\u0388":"\u0395\u0301",                 // GREEK CAPITAL LETTER EPSILON WITH TONOS
    "\u0389":"\u0397\u0301",                 // GREEK CAPITAL LETTER ETA WITH TONOS
    "\u038A":"\u0399\u0301",                 // GREEK CAPITAL LETTER IOTA WITH TONOS
    "\u038C":"\u039F\u0301",                 // GREEK CAPITAL LETTER OMICRON WITH TONOS
    "\u038E":"\u03A5\u0301",                 // GREEK CAPITAL LETTER UPSILON WITH TONOS
    "\u038F":"\u03A9\u0301",                 // GREEK CAPITAL LETTER OMEGA WITH TONOS
    "\u0390":"\u03B9\u0308\u0301",           // GREEK SMALL LETTER IOTA WITH DIALYTIKA AND TONOS
    "\u03AA":"\u0399\u0308",                 // GREEK CAPITAL LETTER IOTA WITH DIALYTIKA
    "\u03AB":"\u03A5\u0308",                 // GREEK CAPITAL LETTER UPSILON WITH DIALYTIKA
    "\u03AC":"\u03B1\u0301",                 // GREEK SMALL LETTER ALPHA WITH TONOS
    "\u03AD":"\u03B5\u0301",                 // GREEK SMALL LETTER EPSILON WITH TONOS
    "\u03AE":"\u03B7\u0301",                 // GREEK SMALL LETTER ETA WITH TONOS
    "\u03AF":"\u03B9\u0301",                 // GREEK SMALL LETTER IOTA WITH TONOS
    "\u03B0":"\u03C5\u0308\u0301",           // GREEK SMALL LETTER UPSILON WITH DIALYTIKA AND TONOS
    "\u03CA":"\u03B9\u0308",                 // GREEK SMALL LETTER IOTA WITH DIALYTIKA
    "\u03CB":"\u03C5\u0308",                 // GREEK SMALL LETTER UPSILON WITH DIALYTIKA
    "\u03CC":"\u03BF\u0301",                 // GREEK SMALL LETTER OMICRON WITH TONOS
    "\u03CD":"\u03C5\u0301",                 // GREEK SMALL LETTER UPSILON WITH TONOS
    "\u03CE":"\u03C9\u0301",                 // GREEK SMALL LETTER OMEGA WITH TONOS
    "\u03D3":"\u03D2\u0301",                 // GREEK UPSILON WITH ACUTE AND HOOK SYMBOL
    "\u03D4":"\u03D2\u0308",                 // GREEK UPSILON WITH DIAERESIS AND HOOK SYMBOL
    "\u1F00":"\u03B1\u0313",                 // GREEK SMALL LETTER ALPHA WITH PSILI
    "\u1F01":"\u03B1\u0314",                 // GREEK SMALL LETTER ALPHA WITH DASIA
    "\u1F02":"\u03B1\u0313\u0300",           // GREEK SMALL LETTER ALPHA WITH PSILI AND VARIA
    "\u1F03":"\u03B1\u0314\u0300",           // GREEK SMALL LETTER ALPHA WITH DASIA AND VARIA
    "\u1F04":"\u03B1\u0313\u0301",           // GREEK SMALL LETTER ALPHA WITH PSILI AND OXIA
    "\u1F05":"\u03B1\u0314\u0301",           // GREEK SMALL LETTER ALPHA WITH DASIA AND OXIA
    "\u1F06":"\u03B1\u0313\u0342",           // GREEK SMALL LETTER ALPHA WITH PSILI AND PERISPOMENI
    "\u1F07":"\u03B1\u0314\u0342",           // GREEK SMALL LETTER ALPHA WITH DASIA AND PERISPOMENI
    "\u1F08":"\u0391\u0313",                 // GREEK CAPITAL LETTER ALPHA WITH PSILI
    "\u1F09":"\u0391\u0314",                 // GREEK CAPITAL LETTER ALPHA WITH DASIA
    "\u1F0A":"\u0391\u0313\u0300",           // GREEK CAPITAL LETTER ALPHA WITH PSILI AND VARIA
    "\u1F0B":"\u0391\u0314\u0300",           // GREEK CAPITAL LETTER ALPHA WITH DASIA AND VARIA
    "\u1F0C":"\u0391\u0313\u0301",           // GREEK CAPITAL LETTER ALPHA WITH PSILI AND OXIA
    "\u1F0D":"\u0391\u0314\u0301",           // GREEK CAPITAL LETTER ALPHA WITH DASIA AND OXIA
    "\u1F0E":"\u0391\u0313\u0342",           // GREEK CAPITAL LETTER ALPHA WITH PSILI AND PERISPOMENI
    "\u1F0F":"\u0391\u0314\u0342",           // GREEK CAPITAL LETTER ALPHA WITH DASIA AND PERISPOMENI
    "\u1F10":"\u03B5\u0313",                 // GREEK SMALL LETTER EPSILON WITH PSILI
    "\u1F11":"\u03B5\u0314",                 // GREEK SMALL LETTER EPSILON WITH DASIA
    "\u1F12":"\u03B5\u0313\u0300",           // GREEK SMALL LETTER EPSILON WITH PSILI AND VARIA
    "\u1F13":"\u03B5\u0314\u0300",           // GREEK SMALL LETTER EPSILON WITH DASIA AND VARIA
    "\u1F14":"\u03B5\u0313\u0301",           // GREEK SMALL LETTER EPSILON WITH PSILI AND OXIA
    "\u1F15":"\u03B5\u0314\u0301",           // GREEK SMALL LETTER EPSILON WITH DASIA AND OXIA
    "\u1F18":"\u0395\u0313",                 // GREEK CAPITAL LETTER EPSILON WITH PSILI
    "\u1F19":"\u0395\u0314",                 // GREEK CAPITAL LETTER EPSILON WITH DASIA
    "\u1F1A":"\u0395\u0313\u0300",           // GREEK CAPITAL LETTER EPSILON WITH PSILI AND VARIA
    "\u1F1B":"\u0395\u0314\u0300",           // GREEK CAPITAL LETTER EPSILON WITH DASIA AND VARIA
    "\u1F1C":"\u0395\u0313\u0301",           // GREEK CAPITAL LETTER EPSILON WITH PSILI AND OXIA
    "\u1F1D":"\u0395\u0314\u0301",           // GREEK CAPITAL LETTER EPSILON WITH DASIA AND OXIA
    "\u1F20":"\u03B7\u0313",                 // GREEK SMALL LETTER ETA WITH PSILI
    "\u1F21":"\u03B7\u0314",                 // GREEK SMALL LETTER ETA WITH DASIA
    "\u1F22":"\u03B7\u0313\u0300",           // GREEK SMALL LETTER ETA WITH PSILI AND VARIA
    "\u1F23":"\u03B7\u0314\u0300",           // GREEK SMALL LETTER ETA WITH DASIA AND VARIA
    "\u1F24":"\u03B7\u0313\u0301",           // GREEK SMALL LETTER ETA WITH PSILI AND OXIA
    "\u1F25":"\u03B7\u0314\u0301",           // GREEK SMALL LETTER ETA WITH DASIA AND OXIA
    "\u1F26":"\u03B7\u0313\u0342",           // GREEK SMALL LETTER ETA WITH PSILI AND PERISPOMENI
    "\u1F27":"\u03B7\u0314\u0342",           // GREEK SMALL LETTER ETA WITH DASIA AND PERISPOMENI
    "\u1F28":"\u0397\u0313",                 // GREEK CAPITAL LETTER ETA WITH PSILI
    "\u1F29":"\u0397\u0314",                 // GREEK CAPITAL LETTER ETA WITH DASIA
    "\u1F2A":"\u0397\u0313\u0300",           // GREEK CAPITAL LETTER ETA WITH PSILI AND VARIA
    "\u1F2B":"\u0397\u0314\u0300",           // GREEK CAPITAL LETTER ETA WITH DASIA AND VARIA
    "\u1F2C":"\u0397\u0313\u0301",           // GREEK CAPITAL LETTER ETA WITH PSILI AND OXIA
    "\u1F2D":"\u0397\u0314\u0301",           // GREEK CAPITAL LETTER ETA WITH DASIA AND OXIA
    "\u1F2E":"\u0397\u0313\u0342",           // GREEK CAPITAL LETTER ETA WITH PSILI AND PERISPOMENI
    "\u1F2F":"\u0397\u0314\u0342",           // GREEK CAPITAL LETTER ETA WITH DASIA AND PERISPOMENI
    "\u1F30":"\u03B9\u0313",                 // GREEK SMALL LETTER IOTA WITH PSILI
    "\u1F31":"\u03B9\u0314",                 // GREEK SMALL LETTER IOTA WITH DASIA
    "\u1F32":"\u03B9\u0313\u0300",           // GREEK SMALL LETTER IOTA WITH PSILI AND VARIA
    "\u1F33":"\u03B9\u0314\u0300",           // GREEK SMALL LETTER IOTA WITH DASIA AND VARIA
    "\u1F34":"\u03B9\u0313\u0301",           // GREEK SMALL LETTER IOTA WITH PSILI AND OXIA
    "\u1F35":"\u03B9\u0314\u0301",           // GREEK SMALL LETTER IOTA WITH DASIA AND OXIA
    "\u1F36":"\u03B9\u0313\u0342",           // GREEK SMALL LETTER IOTA WITH PSILI AND PERISPOMENI
    "\u1F37":"\u03B9\u0314\u0342",           // GREEK SMALL LETTER IOTA WITH DASIA AND PERISPOMENI
    "\u1F38":"\u0399\u0313",                 // GREEK CAPITAL LETTER IOTA WITH PSILI
    "\u1F39":"\u0399\u0314",                 // GREEK CAPITAL LETTER IOTA WITH DASIA
    "\u1F3A":"\u0399\u0313\u0300",           // GREEK CAPITAL LETTER IOTA WITH PSILI AND VARIA
    "\u1F3B":"\u0399\u0314\u0300",           // GREEK CAPITAL LETTER IOTA WITH DASIA AND VARIA
    "\u1F3C":"\u0399\u0313\u0301",           // GREEK CAPITAL LETTER IOTA WITH PSILI AND OXIA
    "\u1F3D":"\u0399\u0314\u0301",           // GREEK CAPITAL LETTER IOTA WITH DASIA AND OXIA
    "\u1F3E":"\u0399\u0313\u0342",           // GREEK CAPITAL LETTER IOTA WITH PSILI AND PERISPOMENI
    "\u1F3F":"\u0399\u0314\u0342",           // GREEK CAPITAL LETTER IOTA WITH DASIA AND PERISPOMENI
    "\u1F40":"\u03BF\u0313",                 // GREEK SMALL LETTER OMICRON WITH PSILI
    "\u1F41":"\u03BF\u0314",                 // GREEK SMALL LETTER OMICRON WITH DASIA
    "\u1F42":"\u03BF\u0313\u0300",           // GREEK SMALL LETTER OMICRON WITH PSILI AND VARIA
    "\u1F43":"\u03BF\u0314\u0300",           // GREEK SMALL LETTER OMICRON WITH DASIA AND VARIA
    "\u1F44":"\u03BF\u0313\u0301",           // GREEK SMALL LETTER OMICRON WITH PSILI AND OXIA
    "\u1F45":"\u03BF\u0314\u0301",           // GREEK SMALL LETTER OMICRON WITH DASIA AND OXIA
    "\u1F48":"\u039F\u0313",                 // GREEK CAPITAL LETTER OMICRON WITH PSILI
    "\u1F49":"\u039F\u0314",                 // GREEK CAPITAL LETTER OMICRON WITH DASIA
    "\u1F4A":"\u039F\u0313\u0300",           // GREEK CAPITAL LETTER OMICRON WITH PSILI AND VARIA
    "\u1F4B":"\u039F\u0314\u0300",           // GREEK CAPITAL LETTER OMICRON WITH DASIA AND VARIA
    "\u1F4C":"\u039F\u0313\u0301",           // GREEK CAPITAL LETTER OMICRON WITH PSILI AND OXIA
    "\u1F4D":"\u039F\u0314\u0301",           // GREEK CAPITAL LETTER OMICRON WITH DASIA AND OXIA
    "\u1F50":"\u03C5\u0313",                 // GREEK SMALL LETTER UPSILON WITH PSILI
    "\u1F51":"\u03C5\u0314",                 // GREEK SMALL LETTER UPSILON WITH DASIA
    "\u1F52":"\u03C5\u0313\u0300",           // GREEK SMALL LETTER UPSILON WITH PSILI AND VARIA
    "\u1F53":"\u03C5\u0314\u0300",           // GREEK SMALL LETTER UPSILON WITH DASIA AND VARIA
    "\u1F54":"\u03C5\u0313\u0301",           // GREEK SMALL LETTER UPSILON WITH PSILI AND OXIA
    "\u1F55":"\u03C5\u0314\u0301",           // GREEK SMALL LETTER UPSILON WITH DASIA AND OXIA
    "\u1F56":"\u03C5\u0313\u0342",           // GREEK SMALL LETTER UPSILON WITH PSILI AND PERISPOMENI
    "\u1F57":"\u03C5\u0314\u0342",           // GREEK SMALL LETTER UPSILON WITH DASIA AND PERISPOMENI
    "\u1F59":"\u03A5\u0314",                 // GREEK CAPITAL LETTER UPSILON WITH DASIA
    "\u1F5B":"\u03A5\u0314\u0300",           // GREEK CAPITAL LETTER UPSILON WITH DASIA AND VARIA
    "\u1F5D":"\u03A5\u0314\u0301",           // GREEK CAPITAL LETTER UPSILON WITH DASIA AND OXIA
    "\u1F5F":"\u03A5\u0314\u0342",           // GREEK CAPITAL LETTER UPSILON WITH DASIA AND PERISPOMENI
    "\u1F60":"\u03C9\u0313",                 // GREEK SMALL LETTER OMEGA WITH PSILI
    "\u1F61":"\u03C9\u0314",                 // GREEK SMALL LETTER OMEGA WITH DASIA
    "\u1F62":"\u03C9\u0313\u0300",           // GREEK SMALL LETTER OMEGA WITH PSILI AND VARIA
    "\u1F63":"\u03C9\u0314\u0300",           // GREEK SMALL LETTER OMEGA WITH DASIA AND VARIA
    "\u1F64":"\u03C9\u0313\u0301",           // GREEK SMALL LETTER OMEGA WITH PSILI AND OXIA
    "\u1F65":"\u03C9\u0314\u0301",           // GREEK SMALL LETTER OMEGA WITH DASIA AND OXIA
    "\u1F66":"\u03C9\u0313\u0342",           // GREEK SMALL LETTER OMEGA WITH PSILI AND PERISPOMENI
    "\u1F67":"\u03C9\u0314\u0342",           // GREEK SMALL LETTER OMEGA WITH DASIA AND PERISPOMENI
    "\u1F68":"\u03A9\u0313",                 // GREEK CAPITAL LETTER OMEGA WITH PSILI
    "\u1F69":"\u03A9\u0314",                 // GREEK CAPITAL LETTER OMEGA WITH DASIA
    "\u1F6A":"\u03A9\u0313\u0300",           // GREEK CAPITAL LETTER OMEGA WITH PSILI AND VARIA
    "\u1F6B":"\u03A9\u0314\u0300",           // GREEK CAPITAL LETTER OMEGA WITH DASIA AND VARIA
    "\u1F6C":"\u03A9\u0313\u0301",           // GREEK CAPITAL LETTER OMEGA WITH PSILI AND OXIA
    "\u1F6D":"\u03A9\u0314\u0301",           // GREEK CAPITAL LETTER OMEGA WITH DASIA AND OXIA
    "\u1F6E":"\u03A9\u0313\u0342",           // GREEK CAPITAL LETTER OMEGA WITH PSILI AND PERISPOMENI
    "\u1F6F":"\u03A9\u0314\u0342",           // GREEK CAPITAL LETTER OMEGA WITH DASIA AND PERISPOMENI
    "\u1F70":"\u03B1\u0300",                 // GREEK SMALL LETTER ALPHA WITH VARIA
    "\u1F71":"\u03B1\u0301",                 // GREEK SMALL LETTER ALPHA WITH OXIA
    "\u1F72":"\u03B5\u0300",                 // GREEK SMALL LETTER EPSILON WITH VARIA
    "\u1F73":"\u03B5\u0301",                 // GREEK SMALL LETTER EPSILON WITH OXIA
    "\u1F74":"\u03B7\u0300",                 // GREEK SMALL LETTER ETA WITH VARIA
    "\u1F75":"\u03B7\u0301",                 // GREEK SMALL LETTER ETA WITH OXIA
    "\u1F76":"\u03B9\u0300",                 // GREEK SMALL LETTER IOTA WITH VARIA
    "\u1F77":"\u03B9\u0301",                 // GREEK SMALL LETTER IOTA WITH OXIA
    "\u1F78":"\u03BF\u0300",                 // GREEK SMALL LETTER OMICRON WITH VARIA
    "\u1F79":"\u03BF\u0301",                 // GREEK SMALL LETTER OMICRON WITH OXIA
    "\u1F7A":"\u03C5\u0300",                 // GREEK SMALL LETTER UPSILON WITH VARIA
    "\u1F7B":"\u03C5\u0301",                 // GREEK SMALL LETTER UPSILON WITH OXIA
    "\u1F7C":"\u03C9\u0300",                 // GREEK SMALL LETTER OMEGA WITH VARIA
    "\u1F7D":"\u03C9\u0301",                 // GREEK SMALL LETTER OMEGA WITH OXIA
    "\u1F80":"\u03B1\u0313\u0345",           // GREEK SMALL LETTER ALPHA WITH PSILI AND YPOGEGRAMMENI
    "\u1F81":"\u03B1\u0314\u0345",           // GREEK SMALL LETTER ALPHA WITH DASIA AND YPOGEGRAMMENI
    "\u1F82":"\u03B1\u0313\u0300\u0345",     // GREEK SMALL LETTER ALPHA WITH PSILI AND VARIA AND YPOGEGRAMMENI
    "\u1F83":"\u03B1\u0314\u0300\u0345",     // GREEK SMALL LETTER ALPHA WITH DASIA AND VARIA AND YPOGEGRAMMENI
    "\u1F84":"\u03B1\u0313\u0301\u0345",     // GREEK SMALL LETTER ALPHA WITH PSILI AND OXIA AND YPOGEGRAMMENI
    "\u1F85":"\u03B1\u0314\u0301\u0345",     // GREEK SMALL LETTER ALPHA WITH DASIA AND OXIA AND YPOGEGRAMMENI
    "\u1F86":"\u03B1\u0313\u0342\u0345",     // GREEK SMALL LETTER ALPHA WITH PSILI AND PERISPOMENI AND YPOGEGRAMMENI
    "\u1F87":"\u03B1\u0314\u0342\u0345",     // GREEK SMALL LETTER ALPHA WITH DASIA AND PERISPOMENI AND YPOGEGRAMMENI
    "\u1F88":"\u0391\u0313\u0345",           // GREEK CAPITAL LETTER ALPHA WITH PSILI AND PROSGEGRAMMENI
    "\u1F89":"\u0391\u0314\u0345",           // GREEK CAPITAL LETTER ALPHA WITH DASIA AND PROSGEGRAMMENI
    "\u1F8A":"\u0391\u0313\u0300\u0345",     // GREEK CAPITAL LETTER ALPHA WITH PSILI AND VARIA AND PROSGEGRAMMENI
    "\u1F8B":"\u0391\u0314\u0300\u0345",     // GREEK CAPITAL LETTER ALPHA WITH DASIA AND VARIA AND PROSGEGRAMMENI
    "\u1F8C":"\u0391\u0313\u0301\u0345",     // GREEK CAPITAL LETTER ALPHA WITH PSILI AND OXIA AND PROSGEGRAMMENI
    "\u1F8D":"\u0391\u0314\u0301\u0345",     // GREEK CAPITAL LETTER ALPHA WITH DASIA AND OXIA AND PROSGEGRAMMENI
    "\u1F8E":"\u0391\u0313\u0342\u0345",     // GREEK CAPITAL LETTER ALPHA WITH PSILI AND PERISPOMENI AND PROSGEGRAMMENI
    "\u1F8F":"\u0391\u0314\u0342\u0345",     // GREEK CAPITAL LETTER ALPHA WITH DASIA AND PERISPOMENI AND PROSGEGRAMMENI
    "\u1F90":"\u03B7\u0313\u0345",           // GREEK SMALL LETTER ETA WITH PSILI AND YPOGEGRAMMENI
    "\u1F91":"\u03B7\u0314\u0345",           // GREEK SMALL LETTER ETA WITH DASIA AND YPOGEGRAMMENI
    "\u1F92":"\u03B7\u0313\u0300\u0345",     // GREEK SMALL LETTER ETA WITH PSILI AND VARIA AND YPOGEGRAMMENI
    "\u1F93":"\u03B7\u0314\u0300\u0345",     // GREEK SMALL LETTER ETA WITH DASIA AND VARIA AND YPOGEGRAMMENI
    "\u1F94":"\u03B7\u0313\u0301\u0345",     // GREEK SMALL LETTER ETA WITH PSILI AND OXIA AND YPOGEGRAMMENI
    "\u1F95":"\u03B7\u0314\u0301\u0345",     // GREEK SMALL LETTER ETA WITH DASIA AND OXIA AND YPOGEGRAMMENI
    "\u1F96":"\u03B7\u0313\u0342\u0345",     // GREEK SMALL LETTER ETA WITH PSILI AND PERISPOMENI AND YPOGEGRAMMENI
    "\u1F97":"\u03B7\u0314\u0342\u0345",     // GREEK SMALL LETTER ETA WITH DASIA AND PERISPOMENI AND YPOGEGRAMMENI
    "\u1F98":"\u0397\u0313\u0345",           // GREEK CAPITAL LETTER ETA WITH PSILI AND PROSGEGRAMMENI
    "\u1F99":"\u0397\u0314\u0345",           // GREEK CAPITAL LETTER ETA WITH DASIA AND PROSGEGRAMMENI
    "\u1F9A":"\u0397\u0313\u0300\u0345",     // GREEK CAPITAL LETTER ETA WITH PSILI AND VARIA AND PROSGEGRAMMENI
    "\u1F9B":"\u0397\u0314\u0300\u0345",     // GREEK CAPITAL LETTER ETA WITH DASIA AND VARIA AND PROSGEGRAMMENI
    "\u1F9C":"\u0397\u0313\u0301\u0345",     // GREEK CAPITAL LETTER ETA WITH PSILI AND OXIA AND PROSGEGRAMMENI
    "\u1F9D":"\u0397\u0314\u0301\u0345",     // GREEK CAPITAL LETTER ETA WITH DASIA AND OXIA AND PROSGEGRAMMENI
    "\u1F9E":"\u0397\u0313\u0342\u0345",     // GREEK CAPITAL LETTER ETA WITH PSILI AND PERISPOMENI AND PROSGEGRAMMENI
    "\u1F9F":"\u0397\u0314\u0342\u0345",     // GREEK CAPITAL LETTER ETA WITH DASIA AND PERISPOMENI AND PROSGEGRAMMENI
    "\u1FA0":"\u03C9\u0313\u0345",           // GREEK SMALL LETTER OMEGA WITH PSILI AND YPOGEGRAMMENI
    "\u1FA1":"\u03C9\u0314\u0345",           // GREEK SMALL LETTER OMEGA WITH DASIA AND YPOGEGRAMMENI
    "\u1FA2":"\u03C9\u0313\u0300\u0345",     // GREEK SMALL LETTER OMEGA WITH PSILI AND VARIA AND YPOGEGRAMMENI
    "\u1FA3":"\u03C9\u0314\u0300\u0345",     // GREEK SMALL LETTER OMEGA WITH DASIA AND VARIA AND YPOGEGRAMMENI
    "\u1FA4":"\u03C9\u0313\u0301\u0345",     // GREEK SMALL LETTER OMEGA WITH PSILI AND OXIA AND YPOGEGRAMMENI
    "\u1FA5":"\u03C9\u0314\u0301\u0345",     // GREEK SMALL LETTER OMEGA WITH DASIA AND OXIA AND YPOGEGRAMMENI
    "\u1FA6":"\u03C9\u0313\u0342\u0345",     // GREEK SMALL LETTER OMEGA WITH PSILI AND PERISPOMENI AND YPOGEGRAMMENI
    "\u1FA7":"\u03C9\u0314\u0342\u0345",     // GREEK SMALL LETTER OMEGA WITH DASIA AND PERISPOMENI AND YPOGEGRAMMENI
    "\u1FA8":"\u03A9\u0313\u0345",           // GREEK CAPITAL LETTER OMEGA WITH PSILI AND PROSGEGRAMMENI
    "\u1FA9":"\u03A9\u0314\u0345",           // GREEK CAPITAL LETTER OMEGA WITH DASIA AND PROSGEGRAMMENI
    "\u1FAA":"\u03A9\u0313\u0300\u0345",     // GREEK CAPITAL LETTER OMEGA WITH PSILI AND VARIA AND PROSGEGRAMMENI
    "\u1FAB":"\u03A9\u0314\u0300\u0345",     // GREEK CAPITAL LETTER OMEGA WITH DASIA AND VARIA AND PROSGEGRAMMENI
    "\u1FAC":"\u03A9\u0313\u0301\u0345",     // GREEK CAPITAL LETTER OMEGA WITH PSILI AND OXIA AND PROSGEGRAMMENI
    "\u1FAD":"\u03A9\u0314\u0301\u0345",     // GREEK CAPITAL LETTER OMEGA WITH DASIA AND OXIA AND PROSGEGRAMMENI
    "\u1FAE":"\u03A9\u0313\u0342\u0345",     // GREEK CAPITAL LETTER OMEGA WITH PSILI AND PERISPOMENI AND PROSGEGRAMMENI
    "\u1FAF":"\u03A9\u0314\u0342\u0345",     // GREEK CAPITAL LETTER OMEGA WITH DASIA AND PERISPOMENI AND PROSGEGRAMMENI
    "\u1FB0":"\u03B1\u0306",                 // GREEK SMALL LETTER ALPHA WITH VRACHY
    "\u1FB1":"\u03B1\u0304",                 // GREEK SMALL LETTER ALPHA WITH MACRON
    "\u1FB2":"\u03B1\u0300\u0345",           // GREEK SMALL LETTER ALPHA WITH VARIA AND YPOGEGRAMMENI
    "\u1FB3":"\u03B1\u0345",                 // GREEK SMALL LETTER ALPHA WITH YPOGEGRAMMENI
    "\u1FB4":"\u03B1\u0301\u0345",           // GREEK SMALL LETTER ALPHA WITH OXIA AND YPOGEGRAMMENI
    "\u1FB6":"\u03B1\u0342",                 // GREEK SMALL LETTER ALPHA WITH PERISPOMENI
    "\u1FB7":"\u03B1\u0342\u0345",           // GREEK SMALL LETTER ALPHA WITH PERISPOMENI AND YPOGEGRAMMENI
    "\u1FB8":"\u0391\u0306",                 // GREEK CAPITAL LETTER ALPHA WITH VRACHY
    "\u1FB9":"\u0391\u0304",                 // GREEK CAPITAL LETTER ALPHA WITH MACRON
    "\u1FBA":"\u0391\u0300",                 // GREEK CAPITAL LETTER ALPHA WITH VARIA
    "\u1FBB":"\u0391\u0301",                 // GREEK CAPITAL LETTER ALPHA WITH OXIA
    "\u1FBC":"\u0391\u0345",                 // GREEK CAPITAL LETTER ALPHA WITH PROSGEGRAMMENI
    "\u1FC1":"\u00A8\u0342",                 // GREEK DIALYTIKA AND PERISPOMENI
    "\u1FC2":"\u03B7\u0300\u0345",           // GREEK SMALL LETTER ETA WITH VARIA AND YPOGEGRAMMENI
    "\u1FC3":"\u03B7\u0345",                 // GREEK SMALL LETTER ETA WITH YPOGEGRAMMENI
    "\u1FC4":"\u03B7\u0301\u0345",           // GREEK SMALL LETTER ETA WITH OXIA AND YPOGEGRAMMENI
    "\u1FC6":"\u03B7\u0342",                 // GREEK SMALL LETTER ETA WITH PERISPOMENI
    "\u1FC7":"\u03B7\u0342\u0345",           // GREEK SMALL LETTER ETA WITH PERISPOMENI AND YPOGEGRAMMENI
    "\u1FC8":"\u0395\u0300",                 // GREEK CAPITAL LETTER EPSILON WITH VARIA
    "\u1FC9":"\u0395\u0301",                 // GREEK CAPITAL LETTER EPSILON WITH OXIA
    "\u1FCA":"\u0397\u0300",                 // GREEK CAPITAL LETTER ETA WITH VARIA
    "\u1FCB":"\u0397\u0301",                 // GREEK CAPITAL LETTER ETA WITH OXIA
    "\u1FCC":"\u0397\u0345",                 // GREEK CAPITAL LETTER ETA WITH PROSGEGRAMMENI
    "\u1FCD":"\u1FBF\u0300",                 // GREEK PSILI AND VARIA
    "\u1FCE":"\u1FBF\u0301",                 // GREEK PSILI AND OXIA
    "\u1FCF":"\u1FBF\u0342",                 // GREEK PSILI AND PERISPOMENI
    "\u1FD0":"\u03B9\u0306",                 // GREEK SMALL LETTER IOTA WITH VRACHY
    "\u1FD1":"\u03B9\u0304",                 // GREEK SMALL LETTER IOTA WITH MACRON
    "\u1FD2":"\u03B9\u0308\u0300",           // GREEK SMALL LETTER IOTA WITH DIALYTIKA AND VARIA
    "\u1FD3":"\u03B9\u0308\u0301",           // GREEK SMALL LETTER IOTA WITH DIALYTIKA AND OXIA
    "\u1FD6":"\u03B9\u0342",                 // GREEK SMALL LETTER IOTA WITH PERISPOMENI
    "\u1FD7":"\u03B9\u0308\u0342",           // GREEK SMALL LETTER IOTA WITH DIALYTIKA AND PERISPOMENI
    "\u1FD8":"\u0399\u0306",                 // GREEK CAPITAL LETTER IOTA WITH VRACHY
    "\u1FD9":"\u0399\u0304",                 // GREEK CAPITAL LETTER IOTA WITH MACRON
    "\u1FDA":"\u0399\u0300",                 // GREEK CAPITAL LETTER IOTA WITH VARIA
    "\u1FDB":"\u0399\u0301",                 // GREEK CAPITAL LETTER IOTA WITH OXIA
    "\u1FDD":"\u1FFE\u0300",                 // GREEK DASIA AND VARIA
    "\u1FDE":"\u1FFE\u0301",                 // GREEK DASIA AND OXIA
    "\u1FDF":"\u1FFE\u0342",                 // GREEK DASIA AND PERISPOMENI
    "\u1FE0":"\u03C5\u0306",                 // GREEK SMALL LETTER UPSILON WITH VRACHY
    "\u1FE1":"\u03C5\u0304",                 // GREEK SMALL LETTER UPSILON WITH MACRON
    "\u1FE2":"\u03C5\u0308\u0300",           // GREEK SMALL LETTER UPSILON WITH DIALYTIKA AND VARIA
    "\u1FE3":"\u03C5\u0308\u0301",           // GREEK SMALL LETTER UPSILON WITH DIALYTIKA AND OXIA
    "\u1FE4":"\u03C1\u0313",                 // GREEK SMALL LETTER RHO WITH PSILI
    "\u1FE5":"\u03C1\u0314",                 // GREEK SMALL LETTER RHO WITH DASIA
    "\u1FE6":"\u03C5\u0342",                 // GREEK SMALL LETTER UPSILON WITH PERISPOMENI
    "\u1FE7":"\u03C5\u0308\u0342",           // GREEK SMALL LETTER UPSILON WITH DIALYTIKA AND PERISPOMENI
    "\u1FE8":"\u03A5\u0306",                 // GREEK CAPITAL LETTER UPSILON WITH VRACHY
    "\u1FE9":"\u03A5\u0304",                 // GREEK CAPITAL LETTER UPSILON WITH MACRON
    "\u1FEA":"\u03A5\u0300",                 // GREEK CAPITAL LETTER UPSILON WITH VARIA
    "\u1FEB":"\u03A5\u0301",                 // GREEK CAPITAL LETTER UPSILON WITH OXIA
    "\u1FEC":"\u03A1\u0314",                 // GREEK CAPITAL LETTER RHO WITH DASIA
    "\u1FED":"\u00A8\u0300",                 // GREEK DIALYTIKA AND VARIA
    "\u1FEE":"\u00A8\u0301",                 // GREEK DIALYTIKA AND OXIA
    "\u1FF2":"\u03C9\u0300\u0345",           // GREEK SMALL LETTER OMEGA WITH VARIA AND YPOGEGRAMMENI
    "\u1FF3":"\u03C9\u0345",                 // GREEK SMALL LETTER OMEGA WITH YPOGEGRAMMENI
    "\u1FF4":"\u03C9\u0301\u0345",           // GREEK SMALL LETTER OMEGA WITH OXIA AND YPOGEGRAMMENI
    "\u1FF6":"\u03C9\u0342",                 // GREEK SMALL LETTER OMEGA WITH PERISPOMENI
    "\u1FF7":"\u03C9\u0342\u0345",           // GREEK SMALL LETTER OMEGA WITH PERISPOMENI AND YPOGEGRAMMENI
    "\u1FF8":"\u039F\u0300",                 // GREEK CAPITAL LETTER OMICRON WITH VARIA
    "\u1FF9":"\u039F\u0301",                 // GREEK CAPITAL LETTER OMICRON WITH OXIA
    "\u1FFA":"\u03A9\u0300",                 // GREEK CAPITAL LETTER OMEGA WITH VARIA
    "\u1FFB":"\u03A9\u0301",                 // GREEK CAPITAL LETTER OMEGA WITH OXIA
    "\u1FFC":"\u03A9\u0345"                  // GREEK CAPITAL LETTER OMEGA WITH PROSGEGRAMMENI
};

var finalSigmaRe = /\u03c3(?=$|'\W|[\s.,?!":;\u00b7\u0387\u003b\u037E\u2014])/g;

var u2b = {
    "\u00b7": ":", // Colon
    "\u0387": ":", // Colon // see TLG note
    "\u003b": ";", // Question Mark
    "\u037E": ";", // Question Mark // see TLG note
    "\u2019": "'", // Apostrophe
    "\u2010": "-", // Hyphen
    "\u2014": "_", // Dash

    "\u0300": "\\",// COMBINING GRAVE ACCENT
    "\u0301": "/", // COMBINING ACUTE ACCENT
    "\u0308": "+", // COMBINING DIAERESIS
    //"\u0304": "&", // COMBINING MACRON
    //"\u0306": "'", // COMBINING BREVE
    "\u0304": "_", // COMBINING MACRON // Perseus
    "\u0306": "^", // COMBINING BREVE  // Perseus

    "\u0313": ")", // COMBINING COMMA ABOVE
    "\u0314": "(", // COMBINING REVERSED COMMA ABOVE
    "\u0323": "?", // COMBINING DOT BELOW
    "\u0342": "=", // COMBINING GREEK PERISPOMENI
    "\u0345": "|", // COMBINING GREEK YPOGEGRAMMENI

    "\u03b1": "a", // GREEK SMALL LETTER ALPHA
    "\u03b2": "b", // GREEK SMALL LETTER BETA
    "\u03b3": "g", // GREEK SMALL LETTER GAMMA
    "\u03b4": "d", // GREEK SMALL LETTER DELTA
    "\u03b5": "e", // GREEK SMALL LETTER EPSILON
    "\u03dd": "v", // GREEK SMALL LETTER DIGAMMA
    "\u03b6": "z", // GREEK SMALL LETTER ZETA
    "\u03b7": "h", // GREEK SMALL LETTER ETA
    "\u03b8": "q", // GREEK SMALL LETTER THETA
    "\u03b9": "i", // GREEK SMALL LETTER IOTA
    "\u03ba": "k", // GREEK SMALL LETTER KAPPA
    "\u03bb": "l", // GREEK SMALL LETTER LAMDA
    "\u03bc": "m", // GREEK SMALL LETTER MU
    "\u03bd": "n", // GREEK SMALL LETTER NU
    "\u03be": "c", // GREEK SMALL LETTER XI
    "\u03bf": "o", // GREEK SMALL LETTER OMICRON
    "\u03c0": "p", // GREEK SMALL LETTER PI
    "\u03c1": "r", // GREEK SMALL LETTER RHO
    "\u03c3": "s", // GREEK SMALL LETTER SIGMA
    "\u03c2": "s", // GREEK SMALL LETTER FINAL SIGMA
    "\u03f2": "s", // GREEK LUNATE SIGMA SYMBOL
    "\u03c4": "t", // GREEK SMALL LETTER TAU
    "\u03c5": "u", // GREEK SMALL LETTER UPSILON
    "\u03c6": "f", // GREEK SMALL LETTER PHI
    "\u03c7": "x", // GREEK SMALL LETTER CHI
    "\u03c8": "y", // GREEK SMALL LETTER PSI
    "\u03c9": "w"  // GREEK SMALL LETTER OMEGA
};

var b2u = {
    ":": "\u00b7", //
    ";": "\u003b", //
    //"'": "\u2019", //
    "-": "\u2010", //
    //"_": "\u2014", //

    "\\":"\u0300", // COMBINING GRAVE ACCENT
    "/": "\u0301", // COMBINING ACUTE ACCENT
    "+": "\u0308", // COMBINING DIAERESIS
    ")": "\u0313", // COMBINING COMMA ABOVE
    "(": "\u0314", // COMBINING REVERSED COMMA ABOVE
    "?": "\u0323", // COMBINING DOT BELOW
    "=": "\u0342", // COMBINING GREEK PERISPOMENI
    "|": "\u0345", // COMBINING GREEK YPOGEGRAMMENI

    "&": "\u0304", // COMBINING MACRON
    // "'": "\u0306", // COMBINING BREVE // Perseus
    "_": "\u0304", // COMBINING MACRON  // Perseus
    "^": "\u0306", // COMBINING BREVE   // Perseus

    "a": "\u03b1", // GREEK SMALL LETTER ALPHA
    "b": "\u03b2", // GREEK SMALL LETTER BETA
    "g": "\u03b3", // GREEK SMALL LETTER GAMMA
    "d": "\u03b4", // GREEK SMALL LETTER DELTA
    "e": "\u03b5", // GREEK SMALL LETTER EPSILON
    "v": "\u03dd", // GREEK SMALL LETTER DIGAMMA
    "z": "\u03b6", // GREEK SMALL LETTER ZETA
    "h": "\u03b7", // GREEK SMALL LETTER ETA
    "q": "\u03b8", // GREEK SMALL LETTER THETA
    "i": "\u03b9", // GREEK SMALL LETTER IOTA
    "k": "\u03ba", // GREEK SMALL LETTER KAPPA
    "l": "\u03bb", // GREEK SMALL LETTER LAMDA
    "m": "\u03bc", // GREEK SMALL LETTER MU
    "n": "\u03bd", // GREEK SMALL LETTER NU
    "c": "\u03be", // GREEK SMALL LETTER XI
    "o": "\u03bf", // GREEK SMALL LETTER OMICRON
    "p": "\u03c0", // GREEK SMALL LETTER PI
    "r": "\u03c1", // GREEK SMALL LETTER RHO
    "s": "\u03c3", // GREEK SMALL LETTER SIGMA
    "j": "\u03c3", // GREEK SMALL LETTER SIGMA
    //"s": "\u03c2", // GREEK SMALL LETTER FINAL SIGMA
    //"s": "\u03f2", // GREEK LUNATE SIGMA SYMBOL
    "t": "\u03c4", // GREEK SMALL LETTER TAU
    "u": "\u03c5", // GREEK SMALL LETTER UPSILON
    "f": "\u03c6", // GREEK SMALL LETTER PHI
    "x": "\u03c7", // GREEK SMALL LETTER CHI
    "y": "\u03c8", // GREEK SMALL LETTER PSI
    "w": "\u03c9"  // GREEK SMALL LETTER OMEGA
};

// Reverse composition index
var decompRI = Object.keys(decomp).reduce(function(o, c) {
    return o[decomp[c]] = c, o;
}, {});

// Reverse composition index, relaxed
var decompRIX = Object.keys(decomp).reduce(function(o, c) {
    return o[decomp[c].split("").sort().join("")] = c, o;
}, {});


var decompose = function(str) {
    return str.replace(/./g, function($0) {
        return decomp[$0] || $0;
    });
};

var compose = function(str) {
    var r = new RegExp(".[" + diacritics + "]+", "g");
    return str.replace(r, function($0) {
        var head = $0, tail = "";
        while(head.length) {
            if(decompRI[head])
                return decompRI[head] + tail;
            tail = head.slice(-1) + tail;
            head = head.slice(0, -1);
        }
        return $0;
    });
};

var relaxedCompose = function(str) {
    var r = new RegExp(".[" + diacritics + "\u0323" + "]+", "g");
    return str.replace(r, function($0) {
        var head = $0, tail = "";

        // remove dots if any
        head = head.replace(/\u0323/g, function($0) {
            tail += $0;
            return "";
        });

        while(head.length) {
            var h = head.split("").sort().join("");
            if(decompRIX[h])
                return decompRIX[h] + tail;
            tail = head.slice(-1) + tail;
            head = head.slice(0, -1);
        }
        return $0;
    });
};

var translate = function(table, str) {
    return str.replace(/./g, function($0) {
        if(table[$0])
            return table[$0];
        var s = $0.toLowerCase();
        if(table[s])
            return table[s].toUpperCase();
        return $0;
    });
};

// Public methods


var cleanup = function(str) {
    str = relaxedCompose(decompose(str));

    var r = new RegExp("[" + diacritics + "]", "g");
    //        str = str.replace(r, function($0) {
    //            return diacriticsNC[$0] || $0;
    //        });
    str = str.replace(/\u03c2/g, "\u03c3");
    str = str.replace(finalSigmaRe, "\u03c2");

    return str;
};

// NFC normalization
var normalizeCompose = function(str) {
    return compose(decompose(str));
};

// NFD normalization
var normalizeDecompose = function(str) {
    return decompose(compose(str));
};

var toBeta = function(str, useUpperCase) {
    var s = translate(u2b, decompose(str));
    if(!useUpperCase) {
        s = s.replace(/([A-Z])([\\/+()?=|&']*)/g, function($0, $1, $2) {
            return "*" + $2 + $1.toLowerCase();
        });
    }
    return s;

};

var fromBeta = function(str) {
    // shift sign precedes diacritics, e.g. "*)axilh=os"
    str = str.replace(/\*([^a-z]*)([a-z])/g, function($0, $1, $2) {
        return $2.toUpperCase() + $1;
    });

    // force macron/breve to follow diacritics tou^/ -> tou/^
    str = str.replace(/([_&'^])([\\/+)(?=|]+)/g, function($0, $1, $2) {
        return $2 + $1;
    });

    // forced sigma
    var sigma = {
        "\u000F1": "\u03C3", // GREEK SMALL LETTER SIGMA
        "\u000F2": "\u03C2", // GREEK SMALL LETTER FINAL SIGMA
        "\u000F3": "\u03F2", // GREEK LUNATE SIGMA SYMBOL
        "\u000E1": "\u03A3", // GREEK CAPITAL LETTER SIGMA
        "\u000E2": "\u03A3", // GREEK CAPITAL LETTER SIGMA
        "\u000E3": "\u03F9"  // GREEK CAPITAL LUNATE SIGMA SYMBOL
    };
    str = str.replace(/s(?=[123])/g, "\u000F");
    str = str.replace(/S(?=[123])/g, "\u000E");

    str = translate(b2u, str);
    str = cleanup(str);

    str = str.replace(/[\u000F\u000E][123]/g, function($0) {
        return sigma[$0];
    });

    return str;
};

function lower(s) {
    // *(/a -> a(/
    s = s.toLowerCase();
    s = s.replace(/^('?)\*([^a-z]*)([a-z])/g, "$1$3$2");
    s = s.replace(/\*/g, "");
    return s;
}

module.exports = {
    toBeta: toBeta,
    fromBeta: fromBeta,
    normalizeCompose: normalizeCompose,
    normalizeDecompose: normalizeDecompose,
    cleanup: cleanup,
    lower: lower
};
